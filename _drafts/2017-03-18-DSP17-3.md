---
layout: post
title: "DSP-17 #3: \"Say hello to my little friend\" - writing a \"Hello,
World!\" kernel module for Linux"
author: Stan Drozd
date: 2017-03-18 10:00:00 +0100
categories: dsp17
excerpt: "I failed to think of a penguin metaphor, Scarface will have to do"
tags: dsp17 tutorial kernel modules c compilation
---
Linux is capable of many interesting things, and loadable module functionality
is one of them. Linux kernel modules are just pieces of binary that can get
linked on-the-fly against a running kernel.

This approach is especially nice for speeding up your write-compile-run cycle,
systems that frown upon downtimes or creating drivers that require minimum work
when porting between kernel versions.

Today, we're going to harness that power and write a module that will print two
messages on module load and unload, respectively.

# Prerequisites
* **A (virtual) machine running Linux** - If you're already running Linux the VM
  is optional, as it's hard to break anything with this particular module
* **Basic understanding of C and simple GNU Makefiles** - There's finally gonna
  be C code involved and for our build, we'll use a simple Makefile

# Coding style
Before we write any code it's important to mention *how* to write it. Some
of the most notable guidelines involve:
* **8-space-wide tabs** - Most programmers would probably expect 4 spaces for
  indentation; with Linux we're using actual tab characters set to the width of
  8 spaces; Vim users will be happy to know that a plugin called
  [vim-sleuth][vim-sleuth-gh] can deduce the indentation from the current buffer
  and comply with it accordingly, thus eliminating the need to adjust the
  settings manually
* **80 column line width limit** - Linux is not much different here from other
  coding conventions, i.e. if a longer line significantly benefits readability,
  it's acceptable to leave it be
* **When in doubt, comply with K&R** - When Brian W. Kernighan and Dennis
  Ritchie wrote **"The C programming language"** (a.k.a. **K&R**), their
  creation also established a robust standard for C coding style. In fact, what
  Linux is using can be thought of as a compatible subset of those rules

For a full explanation of the preferred coding style, see [this
doc][coding-style].

# The code
At last, some source code. Here's what my module, called `hello.c`, looks like:

```c
#include <linux/module.h> /* Needed by all modules */
#include <linux/kernel.h> /* For KERN_INFO */

int __init hello_init(void)
{
        printk(KERN_INFO "Hello, world!\n");

        return 0;
}

void __exit hello_exit(void)
{
        printk(KERN_INFO "Goodbye, world!\n");

        return;
}

module_init(hello_init);
module_exit(hello_exit);

MODULE_DESCRIPTION("My \"Hello, World!\" module");
MODULE_AUTHOR("Stan Drozd <drozdziak1@gmail.com>");
MODULE_LICENSE("GPL");

```
*You can also find the code in the course's [repository][kernel-safari].*

Not too scary, right? Let's talk about what the module does.

First, we include `linux/module.h` - a header essential for all Linux kernel
modules. Then, we want `linux/kernel.h` for `printk()` and log
levels. Both of those headers are to be found in the `./include/linux/`
directory of your kernel's source tree or header directory.

`hello_init` is our module's init function - it's supposed to make all
preparations necessary to get a module ready to do its job (in our case we only
want to greet the globe). Init functions are usually called only once on module
load. The `__init` attribute tells your kernel to free the memory `hello_init`
was occupying. For printing the message we're using `printk()` - a `printf()`
kernel equivalent - with a log level macro called `KERN_INFO`, which is meant
for information that is neither error nor debug related. The init function never
takes any parameters and is supposed to return either an `int` equal to `0` or a
**negative** error code, e.g. `-ENOMEM` if a memory allocation fails.  To learn
more error codes and their meaning, see [this header][errno-h].

`hello_exit`, on the other hand, cares about everything that has to do with
cleaning up when your module unloads. It too has an attribute, `__exit`, which
tells your compiler to ignore `hello_exit` when building your code as a built-in
module, as those aren't unloadable anyway (We sure will talk about in-tree
modules in the future :slightly_smiling_face:). Exit functions don't take
parameters and have no return values.

Last but not least, we specify some general info about our module. The macros
`module_init` and `module_exit` will tell kbuild which functions you want to use
for module initialization and cleanup, respectively. As you might expect, the
last three `MODULE_*` macros specify the module's description, author and
license.

# The build
The Makefile for our module is as simple as it gets:

```makefile
obj-m += hello.o

KERNEL_VERSION := $(shell uname -r)

KDIR ?= /lib/modules/$(KERNEL_VERSION)/build

all:
	$(MAKE) -C $(KDIR) M=$(PWD) modules

clean:
	$(MAKE) -C $(KDIR) M=$(PWD) clean
```

If you have enough of a grasp on Makefiles, you'll quickly see that all we do
here is just visit a kernel directory and run its Makefile. We specify an `M`
parameter which stands for the path to our **m**odule's sources. I added a
`KDIR` variable for specifying the desired kernel tree, which defaults to your
currently running kernel.

`obj-m` is a list of objects to compile as loadable modules. Other kernel Makefiles
will also specify `obj-y` and `obj-n` as the collections of modules to build
into the kernel and not to compile at all, respectively (If you ).

# Compiling against the running kernel
To build our module, all we need to do is run `make -jN`:

```shell
$ make -j4
make -C /lib/modules/4.10.4-1-MANJARO/build M=/home/drozdziak1/kernel-safari/dsp17-3 modules
make[1]: Entering directory '/usr/lib/modules/4.10.4-1-MANJARO/build'
  CC [M]  /home/drozdziak1/kernel-safari/dsp17-3/hello.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/drozdziak1/kernel-safari/dsp17-3/hello.mod.o
  LD [M]  /home/drozdziak1/kernel-safari/dsp17-3/hello.ko
make[1]: Leaving directory '/usr/lib/modules/4.10.4-1-MANJARO/build'
```

# Compiling against a specific kernel tree
If you're not using Linux on your machine or simply don't want to run your
module against the running kernel, you can just take a virtual machine (like the
one I showed you [here][dsp-2]) and use its' kernel instead. To do that, we're
going to overwrite `KDIR` in our `make` invocation:

```shell
$ make -j4 KDIR=../linux
make -C ../linux M=/home/drozdziak1/kernel-safari/dsp17-3 modules
make[1]: Entering directory '/home/drozdziak1/kernel-safari/linux'
  CC [M]  /home/drozdziak1/kernel-safari/dsp17-3/hello.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/drozdziak1/kernel-safari/dsp17-3/hello.mod.o
  LD [M]  /home/drozdziak1/kernel-safari/dsp17-3/hello.ko
make[1]: Leaving directory '/home/drozdziak1/kernel-safari/linux'
```
*When building against a kernel tree of your choosing, remember to compile that
kernel first before pointing at it with* `KDIR`.

# Loading and unloading of kernel modules
After your module compiles, you should end up with a bunch of files:
```plaintext
.
├── Makefile
├── Module.symvers
├── hello.c
├── hello.ko
├── hello.mod.c
├── hello.mod.o
├── hello.o
└── modules.order
```

* Explain each file

For attaching and removing our module from the running kernel, we'll use
`insmod` and `rmmod`.

* insmod/rmmod
* dmesg
* inlining of kernel logs in virtual consoles
* modprobe
* lsmod
* modinfo
* out-of-tree module taints kernel

# Can I use my module with any kernel?
* what is vermagic?
* forcing vermagic

# Further reading
* [The fancy new kernel documentation][fancy-kernel-docs]
* [Documentation/process/coding-style.rst][coding-style] - The full kernel docs
  on coding style
* [Documentation/kbuild/modules.txt][kbuild-modules] - More on kernel modules
* [include/linux/init.h][linux-init-h] - More on `__init` and `__exit`

[coding-style]:https://www.kernel.org/doc/html/latest/process/coding-style.html?highlight=coding%20style
[dsp-1]:{% post_url 2017-03-02-DSP17-1-the-kernel-role-in-OS %}
[dsp-2]:{% post_url 2017-03-14-DSP17-2 %}
[errno-h]:http://lxr.free-electrons.com/source/include/uapi/asm-generic/errno.h
[fancy-kernel-docs]:https://www.kernel.org/doc/html/latest/index.html
[kbuild-modules]:http://lxr.free-electrons.com/source/Documentation/kbuild/modules.txt
[kernel-safari]:https://github.com/drozdziak1/kernel-safari
[linux-init-h]:http://lxr.free-electrons.com/source/include/linux/init.h
[vim-sleuth-gh]:https://github.com/tpope/vim-sleuth
